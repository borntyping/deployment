---
- tags:
    - stage1
    - stage1-base
  block:
    - import_tasks: apt.yml
      tags: apt

    - name: install packages
      apt:
        state: latest
        pkg:
          - ack
          - ansible
          - asciinema
          - colordiff
          - curl
          - direnv
          - fd-find
          - git
          - git-lfs
          - golang
          - htop
          - letsencrypt
          - libgit2-dev
          - libxml2-dev
          - libxslt1-dev
          - libyaml-dev
          - nano
          - plantuml
          - python3
          - python3-dev
          - python3-pip
          - shellcheck
          - tree
          - zsh
      become: 'yes'
      tags:
        - bin
        - util

    - name: use zsh
      user:
        name: sam
        shell: /bin/zsh
      tags:
        - zsh
        - user

    - name: configure inotify
      copy:
        src: 60-inotify.conf
        dest: /etc/sysctl.d/60-inotify.conf
      notify: sysctl
      become: 'yes'

    - name: install docker
      apt:
        pkg:
          - docker-ce
          - docker-ce-cli
          - containerd.io
        state: latest
      become: 'yes'

    - name: create docker group
      group:
        name: docker
        state: present
      become: 'yes'

    - name: add current user to docker group
      user:
        name: '{{ lookup("env", "USER") }}'
        groups: docker
        append: true
      become: 'yes'

    - meta: flush_handlers
