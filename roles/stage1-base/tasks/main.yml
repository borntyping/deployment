---
- become: true
  tags:
    - 'stage1'
    - 'stage1-base'
  block:
    - name: 'install dnf packages'
      ansible.builtin.dnf:
        state: 'latest'
        pkg:
          - 'ShellCheck'
          - 'ack'
          - 'ansible-core'
          - 'asciinema'
          - 'bat'
          - 'cargo'
          - 'clippy'
          - 'colordiff'
          - 'curl'
          - 'direnv'
          - 'docker-compose'
          - 'exa'                       # ls replacement
          - 'fd-find'                   # find replacement
          - 'fzf'                       # shell menu
          - 'gcc-c++'                   # needed for cargo install task
          - 'gh'                        # github cli
          - 'git'
          - 'git-lfs'                   # git large file support
          - 'google-chrome-stable'
          - 'htop'
          - 'jq'
          - 'micro'
          - 'nano'
          - 'pipx'
          - 'plantuml'
          - 'podman'
          - 'pre-commit'
          - 'python3'
          - 'python3-black'
          - 'python3-devel'
          - 'python3-flake8'
          - 'python3-mypy'
          - 'python3-pip'
          - 'python3-pytest'
          - 'python3.10'
          - 'python3.11'
          - 'python3.7'
          - 'python3.8'
          - 'python3.9'
          - 'ripgrep'                   # grep replacement
          - 'rust-src'
          - 'rustc'
          - 'rustfmt'
          - 'snapd'
          - 'strace'
          - 'sqlite'
          - 'tree'
          - 'wl-clipboard'              # optional dependency of micro
          - 'zeal'
          - 'zoxide'                    # provides z
          - 'zsh'
          - 'zsh-autosuggestions'
          - 'zsh-html'
          - 'zsh-syntax-highlighting'
      tags:
        - 'dnf'

    - name: 'remove dnf packages'
      ansible.builtin.dnf:
        state: 'absent'
        pkg:
          - 'python3-poetry'
          - 'starship'
      tags:
        - 'dnf'

    - name: 'install 1Password'
      ansible.builtin.dnf:
        state: 'latest'
        pkg: 'https://downloads.1password.com/linux/rpm/stable/x86_64/1password-latest.rpm'
      tags:
        - 'dnf'
        - '1p'

    # https://snapcraft.io/docs/installing-snap-on-fedora
    - name: 'configure snap'
      ansible.builtin.file:
        src: '/var/lib/snapd/snap'
        dest: '/snap'
        state: 'link'
      tags:
        - 'snap'

    - name: 'install snap packages'
      community.general.snap:
        name: '{{ item }}'
      loop:
        - 'slack'
      tags:
        - 'snap'

    - name: 'install snap packages with --classic'
      community.general.snap:
        name: '{{ item }}'
        classic: true
      loop:
        - 'pycharm-professional'
      tags:
        - 'snap'

    - name: 'configure sudo'
      ansible.builtin.copy:
        src: 'etc/sudoers.d/sam'
        dest: '/etc/sudoers.d/sam'
      tags:
        - docker
        - sudo
        - sudoers

    # Configure immediately by running this as root:
    # $ echo 2 >> /sys/module/hid_apple/parameters/fnmode
    - name: 'configure varmilo keyboard'
      ansible.builtin.copy:
        src: 'etc/modprobe.d/hid_apple.conf'
        dest: '/etc/modprobe.d/hid_apple.conf'
      tags:
        - never
        - hardware
