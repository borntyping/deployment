---
- tags:
    - stage1
    - stage1-base
  block:
    - import_tasks: apt.yml
      tags: apt

    - name: install packages
      apt:
        state: latest
        pkg:
          - ack
          - ansible
          - asciinema
          - colordiff
          - curl
          - direnv
          - git
          - git-lfs
          - golang
          - htop
          - letsencrypt
          - libgit2-dev
          - libxml2-dev
          - libxslt1-dev
          - libyaml-dev
          - multitail
          - nano
          - plantuml
          - python3
          - python3-dev
          - python3-pip
          - shellcheck
          - sshuttle
          - tmux
          - tree
          - virtualenvwrapper
          - zsh
      become: 'yes'
      tags:
        - bin
        - util

    - name: configure inotify
      copy:
        src: 60-inotify.conf
        dest: /etc/sysctl.d/60-inotify.conf
      notify: sysctl
      become: 'yes'

    - name: install docker
      apt:
        pkg:
          - docker-engine
        state: latest
      become: 'yes'

    - name: create docker group
      group:
        name: docker
        state: present
      become: 'yes'

    - name: add current user to docker group
      user:
        name: '{{ ansible_env.USER }}'
        groups: docker
        append: true
      become: 'yes'

    - name: install custom services
      copy:
        src: 'etc/systemd/system/'
        dest: '/etc/systemd/system'
        mode: '0755'
      become: 'yes'
      tags:
        - systemd

    - meta: flush_handlers
