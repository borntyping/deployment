---
- tags:
    - stage1
    - stage1-base
  block:
    - import_tasks: apt.yml
      tags: apt

    - name: install packages
      apt:
        pkg: '{{ item }}'
        state: latest
      become: 'yes'
      with_items:
        - ack
        - ansible
        - aptitude
        - asciinema
        - colordiff
        - curl
        - direnv
        - git
        - git-lfs
        - golang
        - htop
        - letsencrypt
        - libgit2-dev
        - libxml2-dev
        - libxslt1-dev
        - libyaml-dev
        - multitail
        - nano
        - nodejs
        - npm
        - openjdk-8-jdk
        - plantuml
        - pypy
        - pypy-dev
        - python
        - python-dev
        - python-pip
        - python-pip-whl
        - python-virtualenv
        - python3
        - python3-dev
        - python3-pip
        - rpm
        - ruby-nokogiri
        - ruby2.5
        - ruby2.5-dev
        - shellcheck
        - silversearcher-ag
        - supervisor
        - supervisor
        - tmux
        - tree
        - virtualenvwrapper
        - zsh
      tags:
        - bin
        - git
        - util

    - name: configure inotify
      copy:
        src: 60-inotify.conf
        dest: /etc/sysctl.d/60-inotify.conf
      notify: sysctl
      become: 'yes'

    - name: install docker
      apt:
        pkg: '{{ item }}'
        state: latest
      become: 'yes'
      with_items:
        - docker-engine
        - apparmor
        - cgroup-lite

    - name: create docker group
      group:
        name: docker
        state: present
      become: 'yes'

    - name: add current user to docker group
      user:
        name: '{{ ansible_env.USER }}'
        groups: docker
        append: true
      become: 'yes'

    - meta: flush_handlers
